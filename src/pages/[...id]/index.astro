---
import type { MarkdownHeading } from "astro";
import { getCollection, render } from "astro:content";
import config, { monolocale } from "$config";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import Icon from "$components/Icon.astro";
import TOC from "$components/TOC.astro";
import Position from "$components/Position.astro";
import Sensitive from "$components/Sensitive.svelte";
import i18nit from "$i18n";

export async function getStaticPaths() {
	// 1. 获取 Note 并生成路径
	const notes = await getCollection("note", note => !note.data.draft);
	const notePaths = notes.map(note => {
		let locale: string | undefined;
		let id: string;
		let pathSlug: string;

		if (monolocale) {
			locale = undefined;
			id = note.id;
			pathSlug = note.id;
		} else {
			const [language, ...ids] = note.id.split("/");
			locale = config.i18n.defaultLocale === language ? undefined : language;
			id = ids.join("/");
			// 如果有 locale (如 zh-cn)，路径为 zh-cn/slug；否则直接是 slug
			pathSlug = locale ? `${locale}/${id}` : id;
		}

		// 显式传递 locale 属性，不依赖 URL 参数解析
		return {
			params: { id: pathSlug },
			props: { item: note, type: "note" as const, locale: locale || config.i18n.defaultLocale }
		};
	});

	// 2. 获取 Jotting 并生成路径
	const jottings = await getCollection("jotting", jotting => !jotting.data.draft);
	const jottingPaths = jottings.map(jotting => {
		let locale: string | undefined;
		let id: string;
		let pathSlug: string;

		if (monolocale) {
			locale = undefined;
			id = jotting.id;
			pathSlug = jotting.id;
		} else {
			const [language, ...ids] = jotting.id.split("/");
			locale = config.i18n.defaultLocale === language ? undefined : language;
			id = ids.join("/");
			pathSlug = locale ? `${locale}/${id}` : id;
		}

		return {
			params: { id: pathSlug },
			props: { item: jotting, type: "jotting" as const, locale: locale || config.i18n.defaultLocale }
		};
	});

	return [...notePaths, ...jottingPaths];
}

// 关键修改：从 props 中直接获取 locale，而不是从 Astro.params 中猜测
// 这样无论 URL 是什么结构，locale 都是正确的
const { item, type, locale } = Astro.props;

// 渲染内容
const { Content, headings, remarkPluginFrontmatter: frontmatter } = await render(item);

// 构建 TOC
type Heading = MarkdownHeading & { subheadings: Heading[] };
const tableOfContents: Heading[] = [];

const stack: Heading[] = [];
for (const item of headings) {
	while (stack[stack.length - 1]?.depth >= item.depth) stack.pop();
	const heading: Heading = { ...item, subheadings: [] };

	if (stack.length > 0) {
		stack[stack.length - 1].subheadings.push(heading);
	} else {
		tableOfContents.push(heading);
	}
	stack.push(heading);
}

const t = i18nit(locale);

const series = type === "note" ? (item.data as any).series : undefined;
// 返回列表页的链接 (列表页仍在 /note 或 /jotting)
const backLink = type === "note" ? "/note" : "/jotting";
const showToc = (item.data as any).toc;
---

<Base title={item.data.title} {locale} description={item.data.description} article={{ timestamp: item.data.timestamp, section: series, tags: item.data.tags }}>
	<main class="flex flex-col gap-6">
		<header class="flex flex-col gap-4">
			<h1 class="text-3xl">{item.data.title}</h1>
			<div class="flex flex-col gap-3 sm:flex-row children:(flex items-center gap-1 text-3.5 c-secondary)">
				<time datetime={item.data.timestamp.toISOString()}><Icon name="lucide:calendar" />{Time.date(item.data.timestamp)}</time>
				{
					series && (
						<span>
							<Icon name="lucide:layers" />
							{series}
						</span>
					)
				}
				{
					!!item.data.tags?.length && (
						<span>
							<Icon name="lucide:hash" />
							{item.data.tags?.join("; ")}
						</span>
					)
				}
				<span><Icon name="lucide:pilcrow" />{t("read.words", { words: frontmatter.words })}</span>
			</div>
			<hr class="b-b b-b-solid b-weak" />
		</header>

		<Sensitive {locale} back={backLink} sensitive={item.data.sensitive} client:load>
			<div class="flex gap-5">
				<section id="markdown-content" class="markdown"><Content /></section>
				{
					showToc && (
						<aside class="hidden sm:(block flex-shrink-0 w-200px)">
							<div class="sticky top-3 flex flex-col gap-2">
								<h3>{t("note.contents")}</h3>
								<nav class="overflow-y-auto">
									<TOC headings={tableOfContents} />
								</nav>
							</div>
						</aside>
					)
				}
			</div>
		</Sensitive>

		<Position {locale} />
	</main>
</Base>