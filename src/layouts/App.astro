---
import { SEO } from "astro-seo";
import { getRelativeLocaleUrl } from "astro:i18n";

const { title, subtitle, description, author, article } = Astro.props;

// Locale-specific Noto Serif font mappings for Google Fonts
const notoFonts: Record<string, string> = {
	en: "https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap",
	"zh-cn": "https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap"
};

// 1. 创建一个清理后的路径：移除 .html 后缀，并移除可能的末尾斜杠
const cleanPath = Astro.url.pathname.replace(/\.html$/, "").replace(/\/$/, "");

// 2. 使用清理后的路径生成 canonicalURL
const canonicalURL = new URL(cleanPath || "/", Astro.site).href;

const fullTitle = subtitle ? `${subtitle} | ${title}` : title;

// 3. 使用清理后的路径生成 ogImage (避免出现 /about.html/graph.png 这种错误路径)
const ogImage = article ? new URL(`${cleanPath}/graph.png`, Astro.site).href : new URL("/graph.png", Astro.site).href;

// 获取当前路径的“纯净版” (Slug)，用于生成多语言链接
// 如果当前在英文版 (如 /en/about)，去掉 /en 得到 /about
// 如果当前在中文版 (如 /about)，直接使用 /about
let i18nSlug = Astro.url.pathname;
if (Astro.currentLocale === "en" && i18nSlug.startsWith("/en")) {
	i18nSlug = i18nSlug.replace(/^\/en/, "") || "/";
}

// 生成绝对路径 (Astro.site 是在配置里写的URL)
// 注意：Astro 的 getRelativeLocaleUrl 会自动处理 prefixDefaultLocale: false 的配置
const zhUrl = new URL(getRelativeLocaleUrl("zh-cn", i18nSlug), Astro.site).href;
const enUrl = new URL(getRelativeLocaleUrl("en", i18nSlug), Astro.site).href;
---

<html lang={Astro.currentLocale}>
    <head>
        <SEO
            charset="utf-8"
            title={fullTitle}
            description={description}
            canonical={canonicalURL}
            twitter={{
                card: "summary_large_image"
            }}
            openGraph={{
                basic: {
                    title: fullTitle,
                    type: article ? "article" : "website",
                    image: ogImage, 
                },
                optional: {
                    description: description,
                    siteName: title,
                },
                article: article ? {
                    publishedTime: article.timestamp.toISOString(),
                    authors: [author],
                    section: article.section,
                    tags: article.tags,
                } : undefined,
            }}
        />

        <link rel="alternate" hreflang="zh-cn" href={zhUrl} />
        <link rel="alternate" hreflang="en" href={enUrl} />
        <link rel="alternate" hreflang="x-default" href={enUrl} />

        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="sitemap" href="/sitemap-index.xml" />

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="preconnect" href="https://fontsapi.zeoseven.com" />
        <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playwrite+MX:wght@100&display=block" />
        <link rel="stylesheet" href="https://fontsapi.zeoseven.com/442/main/result.css" crossorigin />
        <link rel="stylesheet" href="https://fontsapi.zeoseven.com/556/main/result.css" crossorigin />
        <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" onload="this.onload=null;this.rel='stylesheet'" />

        {Astro.currentLocale && notoFonts[Astro.currentLocale] && <link rel="stylesheet" href={notoFonts[Astro.currentLocale]} />}

        <script defer src="https://stats.demosaic.org/script.js" data-website-id="209d4e84-8e36-4a82-887e-fff1f965ca1f" data-domains="memo.demosaic.org"></script>
        <script is:inline>
            var theme = localStorage.getItem("theme");
            if (theme) document.documentElement.dataset.theme = theme;
        </script>
    </head>
    <body>
        <slot />
    </body>
</html>