---
import { getCollection, getEntry, render } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import { monolocale } from "$config";
import Icon from "$components/Icon.astro";
import i18nit from "$i18n";

let { locale, author, copyright } = Astro.props;

const t = i18nit(locale);

let ccURL: string;
let ccLabel: string;

// Map Creative Commons license types to their official URLs and descriptions
switch (copyright.type) {
	case "CC BY 4.0":
		ccURL = "https://creativecommons.org/licenses/by/4.0/";
		ccLabel = "Attribution 4.0 International";
		break;

	case "CC BY-SA 4.0":
		ccURL = "https://creativecommons.org/licenses/by-sa/4.0/";
		ccLabel = "Attribution-ShareAlike 4.0 International";
		break;

	case "CC BY-NC 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nc/4.0/";
		ccLabel = "Creative Commons Attribution-NonCommercial 4.0 International";
		break;

	case "CC BY-NC-SA 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nc-sa/4.0/";
		ccLabel = "Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International";
		break;

	case "CC BY-ND 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nd/4.0/";
		ccLabel = "Creative Commons Attribution-NoDerivatives 4.0 International";
		break;

	case "CC BY-NC-ND 4.0":
		ccURL = "https://creativecommons.org/licenses/by-nc-nd/4.0/";
		ccLabel = "Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International";
		break;

	default: {
		const anchor = locale === "zh-cn" ? "#服务条款-terms-of-service" : "#terms-of-service";
		ccURL = getRelativeLocaleUrl(locale, "policy") + anchor;
		ccLabel = copyright.type;
		break;
	}
}

// Build array of Creative Commons icons based on license type
// 初始化为空数组
const ccIcons = [];
// 只有当协议名称里包含 "CC" 时，才去加载 CC 图标
if (copyright.type.includes("CC")) {
	ccIcons.push("fa6-brands:creative-commons");

	if (copyright.type === "CC0 1.0") {
		ccIcons.push("fa6-brands:creative-commons-zero");
	} else {
		if (copyright.type.includes("BY")) ccIcons.push("fa6-brands:creative-commons-by");
		if (copyright.type.includes("NC")) ccIcons.push("fa6-brands:creative-commons-nc");
		if (copyright.type.includes("SA")) ccIcons.push("fa6-brands:creative-commons-sa");
		if (copyright.type.includes("ND")) ccIcons.push("fa6-brands:creative-commons-nd");
	}
}

// Fetch notes and jottings collections to calculate total word count

const notes = await getCollection("note", note => {
	// Filter by publication status and locale
	let published = !note.data.draft;
	let localed = monolocale || note.id.split("/")[0] === locale;

	return published && localed;
});

// Calculate total word count across all notes
const noteWords = (await Promise.all(notes.map(async note => (await render(note)).remarkPluginFrontmatter.words))).reduce(
	(summary, words) => summary + words,
	0
);

const jottings = await getCollection("jotting", jotting => {
	// Filter by publication status and locale
	let published = !jotting.data.draft;
	let localed = monolocale || jotting.id.split("/")[0] === locale;

	return published && localed;
});

// Calculate total word count across all jottings
const jottingWords = (await Promise.all(jottings.map(async jotting => (await render(jotting)).remarkPluginFrontmatter.words))).reduce(
	(summary, words) => summary + words,
	0
);

// Aggregate total word count
const totalWords = noteWords + jottingWords;

// Check if policy file exists for current locale
const localePrefix = monolocale ? "" : `${locale}/`;
const policy = await getEntry("information", `${localePrefix}policy`);
---

<footer class="flex flex-col sm:flex-row items-center justify-between gap-2 mt-8 mb-5 sm:mb-3 text-size-sm font-mono">
	<div class="flex items-center gap-1">
		{
			copyright.type != "CC0 1.0" && [
				<span>
					<Icon name="lucide:copyright" />
				</span>,
				<span>{copyright.year}</span>
			]
		}
		{
			typeof author === "string" ? (
				<span>{author}</span>
			) : !author.link ? (
				<span>{author.name}</span>
			) : (
				<a href={author.link} target="_blank" rel="noopener noreferrer">
					{author.name}
				</a>
			)
		}
		<span>|</span>
		<a target="_blank" href={ccURL} aria-label={ccLabel} class="flex items-center gap-1 hover:underline">
            {/* 逻辑判断：如果有图标就显示图标，没图标就直接显示文字 */}
            {
                ccIcons.length > 0 
                ? ccIcons.map(icon => <Icon name={icon} />) 
                : <span>{ccLabel}</span>
            }
        </a>
		<span>·</span>
		<span class="contents"><Icon name="lucide:activity" title={t("statistics", { words: totalWords })} /></span>
		{
			policy && [
				<span>·</span>,
				<a href={getRelativeLocaleUrl(locale, "/policy")} aria-label="Policy" class="inline-flex">
					<Icon name="lucide:scale" title={t("navigation.policy")} />
				</a>
			]
		}
	</div>

	{/* 新增：外链部分 */}
	<div class="flex items-center gap-2 text-0.8rem">
		{/* 桌面端显示分隔符，移动端隐藏 */}
		<span class="hidden sm:inline opacity-50">/</span>
		<p>Also on</p>
		<a href="https://stories.demosaic.org/" target="_blank" rel="noopener noreferrer" aria-label="Medium" class="inline-flex hover:text-primary transition-colors">
			<Icon name="simple-icons:medium" title="Medium" />
		</a>
		<a href="https://letters.demosaic.org/" target="_blank" rel="noopener noreferrer" aria-label="Substack" class="inline-flex hover:text-primary transition-colors">
			<Icon name="simple-icons:substack" title="Substack" />
		</a>
		<span>·</span>
		<a href="https://articles.demosaic.org/" target="_blank" rel="noopener noreferrer" aria-label="Ghost" class="inline-flex hover:text-primary transition-colors">
			<Icon name="simple-icons:ghost" title="Blog" />
		</a>
	</div>

	<code class="flex items-center gap-2.5">
        <p>Powered by</p>
        <a href="https://astro.build/" aria-label="Astro" target="_blank" class="inline-flex">
            <Icon name="simple-icons:astro" title="Astro" />
        </a>
        <a href="https://vercel.com/" aria-label="Vercel" target="_blank" class="inline-flex">
            <Icon name="simple-icons:vercel" title="Vercel" />
        </a>
        <span>·</span>
        <a href="https://github.com/tuyuritio/astro-theme-thought-lite" aria-label="Theme" target="_blank" class="inline-flex">
            <Icon name="simple-icons:github" title={t("theme")} inline />
        </a>
    </code>
</footer>
